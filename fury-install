#!/usr/local/bin/bash

# Export our variables
LIVEFS="/"
FSMNT="/mnt"

# Clean up any previous runs
umount -f ${FSMNT}/dev >/dev/null 2>/dev/null || true
zpool list -H | awk -F '\t' '{print $1;}' | xargs -I % zpool export -f % >/dev/null 2>/dev/null || true

# Install contents of read only uzip to destination pool
bsdinstall zfsboot
if [ ! -d "/mnt/usr" ] ; then
  exit 1
fi
su -m root -c 'cd /mnt && dump -0af - /dev/md1.uzip | restore -rf -'

# Cleanup LiveCD restore specific conents from destination pool
chroot ${FSMNT} rm restoresymtable
chroot ${FSMNT} cp /usr/local/etc/sddm.conf.sample /usr/local/etc/sddm.conf
chroot ${FSMNT} rm /usr/local/etc/doas.conf
chroot ${FSMNT} pw userdel liveuser
chroot ${FSMNT} pw groupdel liveuser
chroot ${FSMNT} rm -rf /usr/home/liveuser
chroot ${FSMNT} sysrc -x root_rw_mount="NO"

# Configure the new installation
mount -t devfs devfs ${FSMNT}/dev
bsdinstall rootpass
bsdinstall adduser
bsdinstall time
bsdinstall hostname

# Enable additional services needed for ZFS
if [ ! -f "/mnt/boot/loader.conf" ] ; then
  touch /mnt/boot/loader.conf
fi
chroot ${FSMNT} sysrc -f /boot/loader.conf opensolaris_load="YES"
chroot ${FSMNT} sysrc -f /boot/loader.conf zfs_load="YES"
chroot ${FSMNT} sysrc zfs_enable="YES"

# Commit important config changes from LiveCD to installation
if [ ! -d "/mnt/usr/local/etc/X11/xorg.conf.d" ] ; then
  mkdir /mnt/usr/local/etc/X11/xorg.conf.d
fi
cp -R /usr/local/etc/X11/xorg.conf.d/ ${FSMNT}/usr/local/etc/X11/xorg.conf.d/

# Cleanup and reboot
echo "Installation finished!"
read -p "Press any key to reboot... " -n1 -s
umount -f ${FSMNT}/dev >/dev/null 2>/dev/null || true
zpool list -H | awk -F '\t' '{print $1;}' | xargs -I % zpool export -f % >/dev/null 2>/dev/null || true
shutdown -r now
