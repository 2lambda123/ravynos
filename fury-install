#!/usr/local/bin/bash

LIVEFS="/"
FSMNT="/mnt"

umount -f ${FSMNT}/dev >/dev/null 2>/dev/null || true
zpool list -H | awk -F '\t' '{print $1;}' | xargs -I % zpool export -f % >/dev/null 2>/dev/null || true
bsdinstall zfsboot
if [ ! -d "/mnt/usr" ] ; then
  exit 1
fi
su -m root -c 'cd /mnt && dump -0af - /dev/md1.uzip | restore -rf -'
mount -t devfs devfs ${FSMNT}/dev
chroot ${FSMNT} cp /usr/local/etc/sddm.conf.sample /usr/local/etc/sddm.conf
chroot ${FSMNT} rm /usr/local/etc/doas.conf
chroot ${FSMNT} sed -i '' '/liveuser/d' /etc/passwd
chroot ${FSMNT} sed -i '' '/liveuser/d' /etc/group
chroot ${FSMNT} pwd_mkdb /etc/master.passwd
chroot ${FSMNT} bsdconfig password
chroot ${FSMNT} bsdconfig useradd
chroot ${FSMNT} bsdconfig timezone
chroot ${FSMNT} bsdconfig hostname
chroot ${FSMNT} sysrc -f /boot/loader.conf opensolaris_load="YES"
chroot ${FSMNT} sysrc -f /boot/loader.conf zfs_load="YES"
chroot ${FSMNT} sysrc -x root_rw_mount="NO"
chroot ${FSMNT} sysrc zfs_enable="YES"
echo "Installation finished!"
read -p "Press any key to reboot... " -n1 -s
umount -f ${FSMNT}/dev >/dev/null 2>/dev/null || true
zpool list -H | awk -F '\t' '{print $1;}' | xargs -I % zpool export -f % >/dev/null 2>/dev/null || true
shutdown -r now
